<!DOCTYPE html>
<html>
	<head>
		<title>Ping Pong Game</title>
		<style>
			* {
				margin: 0;
				overflow: hidden;
			}
			canvas {
				box-shadow: black 5px 10px 50px;
				margin-top: 50vh;
				margin-left: 30px;
				transform: translateY(-50%);
			}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<script type="text/javascript" src="js/utils.js"></script>
		<script type="text/javascript" src="js/app.js"></script>
		<script type="text/javascript">
			//Sample functions, remove these functions and design ping-pong game with onInit and onUpdate.

			app.onInit = function () {
				this.nodes.push({
					id: "ball",
					x: this.width / 2,
					y: this.height / 2,
					r: this.width / 60,
					color: "red",
					//make speed dependant on the playground width
					speed: this.width / 360,
					velocityX: -2,
					velocityY: 2,
				});
				this.nodes.push({
					id: "player-1",
					x: this.width / 20 - this.width / 35,
					y: this.height / 4,
					width: this.width / 35,
					height: this.height / 4,
					color: "black",
					speed: this.height / 1000,
					up: false,
					down: false,
					score: 0,
				});

				this.nodes.push({
					id: "player-2",
					x: this.width - this.width / 20,
					y: this.height / 4,
					width: this.width / 35,
					height: this.height / 4,
					color: "black",
					speed: this.height / 1000,
					up: false,
					down: false,
					score: 0,
				});
				this.nodes.push({
					id: "pause-overlay",
					x: 0,
					y: 0,
					width: this.width,
					height: this.height,
					color: "rgba(0,0,0,0.35)",
				});

				//-----------LOGIC TO ENABLE/DISABLE PLAYERS MOVEMENT----------------//
				//controls that allow simultaneous movement of both player
				const movementControls = {
					player1Up: false,
					player1Down: false,
					player2Up: false,
					player2Down: false,
				};

				// updateMovementControls and enableDisablePlayerMovement functions are from utils.js file
				document.addEventListener("keydown", function (e) {
					pauseGame(e);
					restartGame(e);
					updateMovementControls(e, movementControls, true);
					enableDisablePlayerMovement(movementControls);
				});
				document.addEventListener("keyup", function (e) {
					updateMovementControls(e, movementControls, false);
					enableDisablePlayerMovement(movementControls);
				});
			};

			app.onUpdate = function (time) {
				let ballIsMoving = true;
				const ball = this.getNode("ball");
				const player1 = this.getNode("player-1");
				const player2 = this.getNode("player-2");
				let playerInCollision = ball.x < this.width / 2 ? player1 : player2;
				let playerThatScored = ball.x < this.width / 2 ? player2 : player1;

				//================PAUSE SCREEN / NO MOVEMENT=======================//
				if (this.paused) {
					drawPausedTitle();
					drawPausedSubtitle();
					drawRestartCommandOptions();
				}

				//have minimal ball speed (used for small screens)
				if (ball.speed < 2) ball.speed = 2;

				drawPlayerScore(player1.score, 1 / 4);
				drawPlayerScore(player2.score, 3 / 4);

				//when a player scores freeze game for 1.5 seconds
				if (app.freezeGame) return;

				//================ALL GAME MOVEMENT=======================//
				if (!this.paused) {
					//LOGIC to move player's paddle smooth
					movePlayer(player1, time); // function from utils.js file
					movePlayer(player2, time); // function from utils.js file

					//LOGIC to move ball
					ball.x += ball.velocityX * ball.speed;
					ball.y += ball.velocityY * ball.speed;
				}

				//logic if ball hits bottom or top of the canvas
				if (ball.y + ball.r >= this.height || ball.y - ball.r <= 0) {
					//LOGIC to fix an edge case when ball slide on the edge of the board
					if (ball.y - ball.r < 0) {
						ball.y = ball.r;
					}
					if (ball.y + ball.r >= this.height) {
						ball.y -= ball.r;
					}
					ball.velocityY = -ball.velocityY;
				}

				if (playerScoredCollision(ball)) {
					resetBallAndIncScore(ball, playerThatScored);
				}

				//collision function from utils.js file
				if (collision(ball, playerInCollision)) {
					// we check where the ball hits the paddle
					let collidePoint =
						ball.y - (playerInCollision.y + playerInCollision.height / 2);
					// normalize the value of collidePoint, we need to get numbers between -1 and 1.
					// -player.height/2 < collide Point < player.height/2
					collidePoint = collidePoint / (playerInCollision.height / 2);

					// when the ball hits the top of a paddle we want the ball, to take a -45degrees angle
					// when the ball hits the center of the paddle we want the ball to take a 0degrees angle
					// when the ball hits the bottom of the paddle we want the ball to take a 45degrees
					// Math.PI/4 = 45degrees
					let angleRad = (Math.PI / 4) * collidePoint;

					// change the X and Y velocity and X direction
					let direction = ball.x + ball.r < canvas.width / 2 ? 1 : -1;
					ball.velocityX = direction * ball.speed * Math.cos(angleRad);
					ball.velocityY = ball.speed * Math.sin(angleRad);

					// speed up the ball every time a paddle hits it.
					ball.speed += 0.1;
				}
			};
		</script>
	</body>
</html>
